FROM ubuntu:latest

# Set the default environment variables
ENV LOCATION=docker-mobile
ENV DEBIAN_FRONTEND=noninteractive
ENV HOME=/mobile
ENV docker_volume_path="/shared_folder"
# ENV LAUNCH_COMMAND="serve -s build"

WORKDIR /home/setup

RUN apt-get update && \
    apt-get install -y \
    build-essential \
    curl \
    wget \
    git \
    nano \
    unzip \
    software-properties-common \
    sudo

# Update the system and install required packages
RUN apt update && apt upgrade -y && \
    apt install -y npm xsel wget unzip zip && \
    npm cache clean --force && \
    apt clean

# Install Amazon Corretto (OpenJDK 11)
RUN file_name=amazon-corretto-21-x64-linux-jdk.deb && \
    wget https://corretto.aws/downloads/latest/$file_name && \
    apt install -y ./$file_name && \
    rm $file_name

# Updating environement paths
ENV ANDROID_HOME /usr/local/android-sdk-linux
ENV PATH "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH"

# Install Android SDK Command-Line Tools
RUN mkdir -p ${ANDROID_HOME} && \
    cd ${ANDROID_HOME} && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-7302050_latest.zip && \
    unzip commandlinetools-linux-7302050_latest.zip && \
    rm commandlinetools-linux-7302050_latest.zip && \
    mv cmdline-tools tools && \
    mkdir cmdline-tools && \
    mv tools cmdline-tools/latest

# Downloading gradle
ENV GRADLE_VERSION=8.10.2
RUN wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -P /tmp && \
    unzip -d /opt/gradle /tmp/gradle-*.zip

ENV GRADLE_HOME=/opt/gradle/gradle-${GRADLE_VERSION}
ENV PATH=${GRADLE_HOME}/bin:${PATH}

# Accept licenses and install platform tools and the SDK
RUN yes | sdkmanager --sdk_root=${ANDROID_HOME} --licenses && \
    sdkmanager --sdk_root=${ANDROID_HOME} "platform-tools" "platforms;android-30"

# Set the app ID in advance
ARG APP_ID=com.terarea.terarea

# Set the working directory in the Docker container
WORKDIR ${HOME}

# Copy your project files to the container
COPY . ${HOME}

# Set the app ID in app.json (or app.config.js)
RUN sed -i "s|\"android\": {|\"android\": { \"package\": \"${APP_ID}\",|" ${HOME}/app.json

# Install npm dependencies
RUN timeout 60s npm install && npm cache clean --force || timeout 60s npm install && npm cache clean --force

# Build android directory
RUN npx expo prebuild --clean --no-install

# Modify the build.gradle file
RUN sed -i "/defaultConfig {/a \    manifestPlaceholders = [appAuthRedirectScheme: \"${APP_ID}\"]" android/app/build.gradle

# Change to the android directory
WORKDIR ${HOME}/android

# Build the release version
RUN ./gradlew assembleRelease

# Build the project (optional, uncomment if you want to build here)
# RUN npm run build

# Expose the ports that need to be used
EXPOSE 1024-9000

# Entry point
# CMD ["/bin/bash","-c", "${LAUNCH_COMMAND}" ]
CMD ["/bin/bash"]
